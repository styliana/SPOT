<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPOT - Dodaj Rezerwację</title>
    <link rel="stylesheet" type="text/css" href="public/styles/main.css">
    <link rel="stylesheet" type="text/css" href="public/styles/reservation.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        .map-disabled-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-weight: 600;
            backdrop-filter: blur(2px);
            border-radius: 8px;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .map-container-relative {
            position: relative;
        }
    </style>
</head>
<body>
    
    <header class="main-header">
        <div class="nav-greeting">
            <?php if (isset($_SESSION['user_name'])): ?>
                Hello, <?php echo htmlspecialchars($_SESSION['user_name']); ?>!
            <?php endif; ?>
        </div>
        <nav class="main-nav">
             <ul>
                 <li><a href="/about" class="nav-link">About</a></li>
                 <li><a href="/mybookings" class="nav-link">My bookings</a></li>
                 <li><a href="/myprofile" class="nav-link">My profile</a></li>
                 <li><a href="/logout" class="nav-link">Log out</a></li>
             </ul>
        </nav>
        <nav class="mobile-nav">
             <a href="/myprofile"><span class="material-icons-outlined">person_outline</span></a>
             <a href="/mybookings"><span class="material-icons-outlined">description</span></a>
             <a href="/logout"><span class="material-icons-outlined">logout</span></a>
        </nav>
    </header>

    <main class="reservation-page-content">
        <h2 class="page-title"><?php echo isset($booking_id) ? 'Edit reservation' : 'Add a reservation'; ?></h2>
        <div class="content-grid">
            <div class="form-wrapper">
                <form class="reservation-form" action="/reservation" method="POST" id="booking-form">
                    
                    <input type="hidden" name="booking_id" value="<?php echo isset($booking_id) ? htmlspecialchars($booking_id) : ''; ?>">

                    <?php if (isset($message)): ?>
                        <div class="message error"><?php echo htmlspecialchars($message); ?></div>
                    <?php endif; ?>
                    
                    <div class="form-group">
                        <label for="date">Date</label>
                        <div class="input-with-icon">
                            <input id="date" type="date" name="date" required 
                                   value="<?php echo htmlspecialchars($selected_date ?? ''); ?>">
                            <span class="material-icons-outlined input-icon">calendar_month</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="start_time">Start Time</label>
                        <div class="input-with-icon">
                            <input id="start_time" type="time" name="start_time" required
                                   value="<?php echo htmlspecialchars($selected_start ?? ''); ?>">
                            <span class="material-icons-outlined input-icon">schedule</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="end_time">End Time</label>
                        <div class="input-with-icon">
                            <input id="end_time" type="time" name="end_time" required
                                   value="<?php echo htmlspecialchars($selected_end ?? ''); ?>">
                            <span class="material-icons-outlined input-icon">schedule</span>
                        </div>
                    </div>

                    <div class="form-spacer"></div>

                    <div class="form-group">
                        <label for="room-id">Selected Room</label>
                        <div class="input-with-icon">
                            <input id="room-id" type="text" name="room_id" placeholder="Select room from map" 
                                   value="<?php echo htmlspecialchars($selected_room_id ?? ''); ?>" readonly required>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn">
                        <?php echo isset($booking_id) ? 'Save changes' : 'Book now'; ?>
                    </button>
                </form>
            </div>

            <div class="map-wrapper">
                <h3 class="subsection-title desktop-only">Choose available room</h3>
                <div class="map-container-relative" id="map-container">
                    <div id="map-overlay" class="map-disabled-overlay">
                        <span>Fill in date and time to see availability</span>
                    </div>
                    <svg id="room-layer" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
                        <rect id="ROOM1" class="room available" width="127.1" height="44.5" x="90.7" y="151.5" />
                        <rect id="AULA1" class="room available" width="168.2" height="98.3" x="234.3" y="100.6" />
                        <rect id="ROOM2" class="room available" width="73.7" height="53.0" x="92.9" y="212.8" />
                        <rect id="ROOM3" class="room available" width="154.4" height="47.6" x="416.4" y="146.0" />
                        <rect id="ROOM4" class="room available" width="63.7" height="142.1" x="102.9" y="377.3" />
                        <rect id="ROOM5" class="room available" width="184.4" height="65.3" x="179.8" y="451.0" />
                        <rect id="STUDYROOM1" class="room available" width="58.4" height="72.2" x="307.3" y="370.3" />
                        <rect id="AULA2" class="room available" width="196.7" height="154.4" x="448.7" y="363.4" />
                    </svg>
                </div>
            </div>
        </div>
    </main>

    <script>
     document.addEventListener('DOMContentLoaded', () => {
         const dateInput = document.getElementById('date');
         const startTimeInput = document.getElementById('start_time');
         const endTimeInput = document.getElementById('end_time');
         const mapOverlay = document.getElementById('map-overlay');
         const roomInput = document.getElementById('room-id');
         const svgMap = document.getElementById('room-layer');

         // === NOWOŚĆ: Ustawiamy dzisiejszą datę jako minimum ===
         const today = new Date().toISOString().split('T')[0];
         dateInput.setAttribute('min', today);
         // ======================================================

         function checkAvailability() {
             const date = dateInput.value;
             const start = startTimeInput.value;
             const end = endTimeInput.value;

             if (!date || !start || !end) {
                 mapOverlay.style.opacity = '1';
                 mapOverlay.style.pointerEvents = 'auto'; 
                 return;
             }

             mapOverlay.style.opacity = '0';
             mapOverlay.style.pointerEvents = 'none'; 

             const data = { date: date, start_time: start, end_time: end };

             fetch('/api/checkAvailability', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(data)
             })
             .then(response => response.json())
             .then(bookedRooms => {
                 document.querySelectorAll('rect.room').forEach(el => {
                     el.classList.remove('unavailable');
                     el.classList.add('available');
                 });

                 bookedRooms.forEach(id => {
                     const roomEl = document.getElementById(id);
                     if (roomEl) {
                         roomEl.classList.remove('available');
                         roomEl.classList.add('unavailable');
                     }
                 });
             })
             .catch(error => console.error('Error:', error));
         }

         [dateInput, startTimeInput, endTimeInput].forEach(input => {
             input.addEventListener('change', checkAvailability);
         });

         svgMap.addEventListener("click", (e) => {
             const room = e.target.closest("rect.room");
             if (!room) return;
             
             if (mapOverlay.style.opacity !== '0') return;

             if (room.classList.contains('unavailable')) {
                 alert(`Ten pokój jest zajęty.`);
                 return;
             }
             
             const roomId = room.id;
             const date = dateInput.value;
             const start = startTimeInput.value;
             const end = endTimeInput.value;

             window.location.href = `/room/${roomId}?date=${date}&start=${start}&end=${end}`;
         });

         const urlParams = new URLSearchParams(window.location.search);
         const selectedRoomId = urlParams.get('room_id');

         if (selectedRoomId) {
             if (roomInput) roomInput.value = selectedRoomId;
             setTimeout(() => {
                const selectedRoomElement = document.getElementById(selectedRoomId);
                if (selectedRoomElement) {
                    selectedRoomElement.classList.remove('available');
                    selectedRoomElement.classList.add('room-selected-active');
                }
             }, 200);
         }
         
         checkAvailability();
     });
     </script>
</body>
</html>