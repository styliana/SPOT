<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPOT - Dodaj Rezerwację</title>
    <link rel="stylesheet" type="text/css" href="/public/styles/main.css">
    <link rel="stylesheet" type="text/css" href="/public/styles/reservation.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <header class="main-header">
        <div class="nav-greeting">
            <?php if (isset($_SESSION['user_name'])): ?>
                Hello, <?php echo htmlspecialchars($_SESSION['user_name']); ?>!
            <?php endif; ?>
        </div>
        <nav class="main-nav">
             <ul>
                 <li><a href="/about" class="nav-link">About</a></li>
                 <li><a href="/mybookings" class="nav-link">My bookings</a></li>
                 <li><a href="/myprofile" class="nav-link">My profile</a></li>
                 <li><a href="/logout" class="nav-link">Log out</a></li>
             </ul>
        </nav>
        <nav class="mobile-nav">
             <a href="/myprofile"><span class="material-icons-outlined">person_outline</span></a>
             <a href="/mybookings"><span class="material-icons-outlined">description</span></a>
             <a href="/logout"><span class="material-icons-outlined">logout</span></a>
        </nav>
    </header>

    <main class="reservation-page-content">
        <h2 class="page-title"><?php echo isset($booking_id) ? 'Edit reservation' : 'Add a reservation'; ?></h2>
        <div class="content-grid">
            <div class="form-wrapper">
                <form class="reservation-form" action="/reservation" method="POST" id="booking-form">
                    
                    <input type="hidden" name="booking_id" id="booking-id-input" value="<?php echo isset($booking_id) ? htmlspecialchars($booking_id) : ''; ?>">
                    <input type="hidden" name="booking_owner_id" id="booking-owner-input" value="<?php echo isset($booking_owner_id) ? htmlspecialchars($booking_owner_id) : ''; ?>">

                    <?php if (isset($message)): ?>
                        <div class="message error"><?php echo htmlspecialchars($message); ?></div>
                    <?php endif; ?>
                    
                    <div class="message error js-error" style="display: none;"></div>
                    
                    <div class="form-group">
                        <label for="date">Date</label>
                        <div class="input-with-icon">
                            <input id="date" type="date" name="date" required 
                                   value="<?php echo htmlspecialchars($selected_date ?? ''); ?>">
                            <span class="material-icons-outlined input-icon">calendar_month</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="start_time">Start Time</label>
                        <div class="input-with-icon">
                            <input id="start_time" type="time" name="start_time" required
                                   value="<?php echo htmlspecialchars($selected_start ?? ''); ?>">
                            <span class="material-icons-outlined input-icon">schedule</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="end_time">End Time</label>
                        <div class="input-with-icon">
                            <input id="end_time" type="time" name="end_time" required
                                   value="<?php echo htmlspecialchars($selected_end ?? ''); ?>">
                            <span class="material-icons-outlined input-icon">schedule</span>
                        </div>
                    </div>
                    <div class="form-spacer"></div>
                    <div class="form-group">
                        <label for="room-id">Selected Room</label>
                        <div class="input-with-icon">
                            <input id="room-id" type="text" name="room_id" placeholder="Select room from map" 
                                   value="<?php echo htmlspecialchars($selected_room_id ?? ''); ?>" readonly required>
                        </div>
                    </div>
                    <button type="submit" class="submit-btn" id="submit-btn">
                        <?php echo isset($booking_id) ? 'Save changes' : 'Book now'; ?>
                    </button>
                </form>
            </div>

            <div class="map-wrapper">
                <h3 class="subsection-title desktop-only">Choose available room</h3>
                <div class="map-container-relative" id="map-container">
                    <div id="map-overlay" class="map-disabled-overlay"><span>Fill in date and time to see availability</span></div>
                    <svg id="room-layer" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
                        <rect id="ROOM1" class="room available" width="127.1" height="44.5" x="90.7" y="151.5" />
                        <rect id="AULA1" class="room available" width="168.2" height="98.3" x="234.3" y="100.6" />
                        <rect id="ROOM2" class="room available" width="73.7" height="53.0" x="92.9" y="212.8" />
                        <rect id="ROOM3" class="room available" width="154.4" height="47.6" x="416.4" y="146.0" />
                        <rect id="ROOM4" class="room available" width="63.7" height="142.1" x="102.9" y="377.3" />
                        <rect id="ROOM5" class="room available" width="184.4" height="65.3" x="179.8" y="451.0" />
                        <rect id="STUDYROOM1" class="room available" width="58.4" height="72.2" x="307.3" y="370.3" />
                        <rect id="AULA2" class="room available" width="196.7" height="154.4" x="448.7" y="363.4" />
                    </svg>
                </div>
            </div>
        </div>
    </main>

    <script>
     document.addEventListener('DOMContentLoaded', () => {
         const dateInput = document.getElementById('date');
         const startTimeInput = document.getElementById('start_time');
         const endTimeInput = document.getElementById('end_time');
         const roomInput = document.getElementById('room-id');
         const submitBtn = document.getElementById('submit-btn');
         
         const bookingIdInput = document.getElementById('booking-id-input');
         const bookingOwnerInput = document.getElementById('booking-owner-input');
         
         const mapOverlay = document.getElementById('map-overlay');
         const svgMap = document.getElementById('room-layer');
         // Szukamy diva do błędów JS, a jeśli go nie ma, używamy tego PHP-owego
         const jsErrorDiv = document.querySelector('.js-error');
         const phpErrorDiv = document.querySelector('.form-wrapper .message.error:not(.js-error)');
         const messageDiv = jsErrorDiv || phpErrorDiv;

         const today = new Date().toISOString().split('T')[0];
         dateInput.setAttribute('min', today);

         // === USPRAWNIENIE 1: Domyślna data ===
         if (!dateInput.value) {
             dateInput.value = today;
         }

         function showMessage(msg) {
             if (messageDiv) {
                 messageDiv.style.display = 'block';
                 messageDiv.textContent = msg;
                 // Jeśli używamy diva PHP, upewnijmy się, że wygląda dobrze
                 if (!messageDiv.classList.contains('js-error')) {
                     messageDiv.classList.add('message', 'error');
                 }
             }
         }

         function clearMessage() {
             if (messageDiv) {
                 messageDiv.style.display = 'none';
                 messageDiv.textContent = '';
             }
         }

         // Generowanie podpisów na mapie
         function generateRoomLabels() {
             const rooms = svgMap.querySelectorAll('rect.room');
             rooms.forEach(room => {
                 const x = parseFloat(room.getAttribute('x'));
                 const y = parseFloat(room.getAttribute('y'));
                 const w = parseFloat(room.getAttribute('width'));
                 const h = parseFloat(room.getAttribute('height'));
                 const id = room.id;

                 const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                 text.setAttribute('x', x + w / 2);
                 text.setAttribute('y', y + h / 2);
                 text.setAttribute('class', 'room-label');
                 text.textContent = id; 

                 svgMap.appendChild(text);
             });
         }
         generateRoomLabels();

         function checkAvailability() {
             clearMessage();
             
             const date = dateInput.value;
             const start = startTimeInput.value;
             const end = endTimeInput.value;
             const bookingId = bookingIdInput.value ? bookingIdInput.value : null; 

             // 1. Sprawdzenie czy pola są wypełnione
             if (!date || !start || !end) {
                 mapOverlay.style.opacity = '1';
                 mapOverlay.style.pointerEvents = 'auto'; 
                 return;
             }

             // === USPRAWNIENIE 2: Walidacja godzin (Client-Side) ===
             if (start >= end) {
                 showMessage('Godzina zakończenia musi być późniejsza niż rozpoczęcia.');
                 mapOverlay.style.opacity = '1';
                 mapOverlay.style.pointerEvents = 'auto';
                 roomInput.value = ''; // Czyścimy wybór pokoju, bo godziny są błędne
                 return; // Przerywamy, nie wysyłamy zapytania do serwera
             }

             // Jeśli walidacja przeszła, odblokowujemy mapę wizualnie (choć dane wciąż się ładują)
             mapOverlay.style.opacity = '0';
             mapOverlay.style.pointerEvents = 'none'; 

             const data = { date: date, start_time: start, end_time: end, booking_id: bookingId };

             fetch('/api/checkAvailability', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(data)
             })
             .then(response => response.json())
             .then(bookedRooms => {
                 // Reset widoku pokoi
                 document.querySelectorAll('rect.room').forEach(el => {
                     el.classList.remove('unavailable', 'room-selected-active');
                     el.classList.add('available');
                     el.style.fill = ""; 
                     el.style.pointerEvents = "";
                     el.style.cursor = "";
                 });

                 // Oznaczanie zajętych pokoi
                 if (Array.isArray(bookedRooms)) {
                     bookedRooms.forEach(rawId => {
                         const dbIdUpper = rawId.trim().toUpperCase();
                         const roomEl = document.getElementById(dbIdUpper);
                         
                         if (roomEl) {
                             roomEl.classList.remove('available', 'room-selected-active');
                             roomEl.classList.add('unavailable');
                             if (roomInput.value.toUpperCase() === dbIdUpper) {
                                 roomInput.value = "";
                             }
                         }
                     });
                 }

                 // Przywracanie zaznaczenia wybranego pokoju (jeśli wciąż dostępny)
                 const currentSelectedId = roomInput.value;
                 if (currentSelectedId) {
                     const selectedEl = document.getElementById(currentSelectedId);
                     if (selectedEl && !selectedEl.classList.contains('unavailable')) {
                         selectedEl.classList.remove('available');
                         selectedEl.classList.add('room-selected-active');
                     } else {
                         // Jeśli wybrany pokój stał się niedostępny przy zmianie godziny
                         roomInput.value = "";
                     }
                 }
             })
             .catch(error => {
                 console.error('Error fetching availability:', error);
                 showMessage('Wystąpił błąd podczas sprawdzania dostępności.');
             });
         }

         [dateInput, startTimeInput, endTimeInput].forEach(input => {
             input.addEventListener('input', checkAvailability);
         });

         svgMap.addEventListener("click", (e) => {
             const room = e.target.closest("rect.room");
             if (!room) return;
             if (mapOverlay.style.opacity !== '0') return;
             if (room.classList.contains('unavailable')) return;
             
             const roomId = room.id;
             const date = dateInput.value;
             const start = startTimeInput.value;
             const end = endTimeInput.value;
             const bookingId = bookingIdInput.value; 
             const ownerId = bookingOwnerInput.value; 

             window.location.href = `/room/${roomId}?date=${date}&start=${start}&end=${end}&booking_id=${bookingId}&owner_id=${ownerId}`;
         });

         // Uruchomienie na starcie (żeby załadować domyślną datę i ew. dostępność)
         checkAvailability();
         
         // Dodatkowa walidacja przy submicie (na wypadek manipulacji HTML)
         const form = document.getElementById('booking-form');
         form.addEventListener('submit', (e) => {
             if (startTimeInput.value >= endTimeInput.value) {
                 e.preventDefault();
                 showMessage('Godzina zakończenia musi być późniejsza niż rozpoczęcia.');
             }
         });
     });
     </script>
</body>
</html>