<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPOT - Dodaj Rezerwację</title>
    <link rel="stylesheet" type="text/css" href="/public/styles/main.css">
    <link rel="stylesheet" type="text/css" href="/public/styles/reservation.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        .map-disabled-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.7); z-index: 10;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-light); font-weight: 600; backdrop-filter: blur(2px);
            border-radius: 8px; transition: opacity 0.3s; pointer-events: none;
        }
        .map-container-relative { position: relative; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="nav-greeting">
            <?php if (isset($_SESSION['user_name'])): ?>
                Hello, <?php echo htmlspecialchars($_SESSION['user_name']); ?>!
            <?php endif; ?>
        </div>
        <nav class="main-nav">
             <ul>
                 <li><a href="/about" class="nav-link">About</a></li>
                 <li><a href="/mybookings" class="nav-link">My bookings</a></li>
                 <li><a href="/myprofile" class="nav-link">My profile</a></li>
                 <li><a href="/logout" class="nav-link">Log out</a></li>
             </ul>
        </nav>
        <nav class="mobile-nav">
             <a href="/myprofile"><span class="material-icons-outlined">person_outline</span></a>
             <a href="/mybookings"><span class="material-icons-outlined">description</span></a>
             <a href="/logout"><span class="material-icons-outlined">logout</span></a>
        </nav>
    </header>

    <main class="reservation-page-content">
        <h2 class="page-title"><?php echo isset($booking_id) ? 'Edit reservation' : 'Add a reservation'; ?></h2>
        <div class="content-grid">
            <div class="form-wrapper">
                <form class="reservation-form" action="/reservation" method="POST" id="booking-form">
                    
                    <input type="hidden" name="booking_id" id="booking-id-input" value="<?php echo isset($booking_id) ? htmlspecialchars($booking_id) : ''; ?>">
                    <input type="hidden" name="booking_owner_id" id="booking-owner-input" value="<?php echo isset($booking_owner_id) ? htmlspecialchars($booking_owner_id) : ''; ?>">

                    <?php if (isset($message)): ?>
                        <div class="message error"><?php echo htmlspecialchars($message); ?></div>
                    <?php endif; ?>
                    
                    <div class="form-group">
                        <label for="date">Date</label>
                        <div class="input-with-icon">
                            <input id="date" type="date" name="date" required 
                                   value="<?php echo htmlspecialchars($selected_date ?? ''); ?>">
                            <span class="material-icons-outlined input-icon">calendar_month</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="start_time">Start Time</label>
                        <div class="input-with-icon">
                            <input id="start_time" type="time" name="start_time" required
                                   value="<?php echo htmlspecialchars($selected_start ?? ''); ?>">
                            <span class="material-icons-outlined input-icon">schedule</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="end_time">End Time</label>
                        <div class="input-with-icon">
                            <input id="end_time" type="time" name="end_time" required
                                   value="<?php echo htmlspecialchars($selected_end ?? ''); ?>">
                            <span class="material-icons-outlined input-icon">schedule</span>
                        </div>
                    </div>
                    <div class="form-spacer"></div>
                    <div class="form-group">
                        <label for="room-id">Selected Room</label>
                        <div class="input-with-icon">
                            <input id="room-id" type="text" name="room_id" placeholder="Select room from map" 
                                   value="<?php echo htmlspecialchars($selected_room_id ?? ''); ?>" readonly required>
                        </div>
                    </div>
                    <button type="submit" class="submit-btn">
                        <?php echo isset($booking_id) ? 'Save changes' : 'Book now'; ?>
                    </button>
                </form>
            </div>

            <div class="map-wrapper">
                <h3 class="subsection-title desktop-only">Choose available room</h3>
                <div class="map-container-relative" id="map-container">
                    <div id="map-overlay" class="map-disabled-overlay"><span>Fill in date and time to see availability</span></div>
                    <svg id="room-layer" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
                        <rect id="ROOM1" class="room available" width="127.1" height="44.5" x="90.7" y="151.5" />
                        <rect id="AULA1" class="room available" width="168.2" height="98.3" x="234.3" y="100.6" />
                        <rect id="ROOM2" class="room available" width="73.7" height="53.0" x="92.9" y="212.8" />
                        <rect id="ROOM3" class="room available" width="154.4" height="47.6" x="416.4" y="146.0" />
                        <rect id="ROOM4" class="room available" width="63.7" height="142.1" x="102.9" y="377.3" />
                        <rect id="ROOM5" class="room available" width="184.4" height="65.3" x="179.8" y="451.0" />
                        <rect id="STUDYROOM1" class="room available" width="58.4" height="72.2" x="307.3" y="370.3" />
                        <rect id="AULA2" class="room available" width="196.7" height="154.4" x="448.7" y="363.4" />
                    </svg>
                </div>
            </div>
        </div>
    </main>

    <script>
     document.addEventListener('DOMContentLoaded', () => {
         const dateInput = document.getElementById('date');
         const startTimeInput = document.getElementById('start_time');
         const endTimeInput = document.getElementById('end_time');
         
         const bookingIdInput = document.getElementById('booking-id-input');
         const bookingOwnerInput = document.getElementById('booking-owner-input');
         
         const mapOverlay = document.getElementById('map-overlay');
         const roomInput = document.getElementById('room-id');
         const svgMap = document.getElementById('room-layer');
         const messageDiv = document.querySelector('.form-wrapper .message.error');

         const today = new Date().toISOString().split('T')[0];
         dateInput.setAttribute('min', today);

         function clearMessage() {
             if (messageDiv) messageDiv.style.display = 'none';
         }

         function checkAvailability() {
             clearMessage();
             
             const date = dateInput.value;
             const start = startTimeInput.value;
             const end = endTimeInput.value;
             // Jeśli pole jest puste (tworzenie), ustawiamy null, żeby PHP się nie pogubił
             const bookingId = bookingIdInput.value ? bookingIdInput.value : null; 

             // Walidacja: czy wszystkie pola są wypełnione?
             if (!date || !start || !end) {
                 mapOverlay.style.opacity = '1';
                 mapOverlay.style.pointerEvents = 'auto'; 
                 return;
             }
             // Jeśli są wypełnione, odkrywamy mapę
             mapOverlay.style.opacity = '0';
             mapOverlay.style.pointerEvents = 'none'; 

             const data = { date: date, start_time: start, end_time: end, booking_id: bookingId };
             console.log("Checking availability for:", data);

             fetch('/api/checkAvailability', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(data)
             })
             .then(response => response.json())
             .then(bookedRooms => {
                 console.log("Booked rooms from DB:", bookedRooms);

                 // 1. RESETUJEMY STAN WSZYSTKICH POKOI
                 document.querySelectorAll('rect.room').forEach(el => {
                     el.classList.remove('unavailable');
                     el.classList.add('available');
                     // Ważne: czyścimy style inline, które mogły zostać po poprzednim sprawdzeniu
                     el.style.fill = ""; 
                     el.style.pointerEvents = "";
                     el.style.cursor = "";
                 });

                 // 2. OZNACZAMY ZAJĘTE POKOJE
                 if (Array.isArray(bookedRooms)) {
                     bookedRooms.forEach(rawId => {
                         const dbIdUpper = rawId.trim().toUpperCase();
                         
                         // Szukamy pokoju na mapie (ignorując wielkość liter)
                         const roomEl = Array.from(document.querySelectorAll('rect.room'))
                                             .find(r => r.id.toUpperCase() === dbIdUpper);
                         
                         if (roomEl) {
                             roomEl.classList.remove('available');
                             roomEl.classList.add('unavailable');

                             // Wymuszamy wygląd "zajęty" bezpośrednio
                             roomEl.style.fill = 'rgba(220, 38, 38, 0.85)'; // Czerwony
                             roomEl.style.cursor = 'not-allowed';
                             roomEl.style.pointerEvents = 'none'; // Blokada klikania

                             // Jeśli użytkownik wybrał ten pokój zanim się zorientował, że jest zajęty -> czyścimy wybór
                             if (roomInput.value.toUpperCase() === roomEl.id.toUpperCase()) {
                                 roomEl.classList.remove('room-selected-active');
                                 roomInput.value = "";
                             }
                         }
                     });
                 }

                 // 3. PRZYWRACAMY ZAZNACZENIE (jeśli pokój nadal jest wolny)
                 const currentSelectedId = roomInput.value;
                 if (currentSelectedId) {
                     const selectedEl = document.getElementById(currentSelectedId);
                     if (selectedEl && !selectedEl.classList.contains('unavailable')) {
                         selectedEl.classList.remove('available');
                         selectedEl.classList.add('room-selected-active');
                     }
                 }
             })
             .catch(error => console.error('Error fetching availability:', error));
         }

         // UŻYWAMY 'input' ZAMIAST 'change' DLA NATYCHMIASTOWEJ REAKCJI
         [dateInput, startTimeInput, endTimeInput].forEach(input => {
             input.addEventListener('input', checkAvailability);
         });

         // Obsługa kliknięcia w mapę
         svgMap.addEventListener("click", (e) => {
             const room = e.target.closest("rect.room");
             if (!room) return;
             
             // Jeśli mapa jest wyszarzona lub pokój zajęty - nic nie rób
             if (mapOverlay.style.opacity !== '0') return;
             if (room.classList.contains('unavailable') || room.style.pointerEvents === 'none') {
                 return;
             }
             
             const roomId = room.id;
             const date = dateInput.value;
             const start = startTimeInput.value;
             const end = endTimeInput.value;
             const bookingId = bookingIdInput.value; 
             const ownerId = bookingOwnerInput.value; 

             // Przechodzimy do szczegółów pokoju
             window.location.href = `/room/${roomId}?date=${date}&start=${start}&end=${end}&booking_id=${bookingId}&owner_id=${ownerId}`;
         });

         // Inicjalizacja przy ładowaniu (ważne dla edycji)
         const urlParams = new URLSearchParams(window.location.search);
         const selectedRoomId = urlParams.get('room_id');
         const urlOwnerId = urlParams.get('owner_id');
         if (urlOwnerId) bookingOwnerInput.value = urlOwnerId;

         if (selectedRoomId) {
             if (roomInput) roomInput.value = selectedRoomId;
             setTimeout(() => {
                const selectedRoomElement = document.getElementById(selectedRoomId);
                if (selectedRoomElement && !selectedRoomElement.classList.contains('unavailable')) {
                    selectedRoomElement.classList.remove('available');
                    selectedRoomElement.classList.add('room-selected-active');
                }
             }, 200);
         }
         
         // Uruchamiamy sprawdzenie od razu (na wypadek, gdyby przeglądarka zapamiętała dane w polach)
         checkAvailability();
     });
     </script>
</body>
</html>